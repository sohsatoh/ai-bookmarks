# テストガイド

このドキュメントは、AI Bookmarksプロジェクトのテスト実装と実行方法について説明します。

## テストの概要

このプロジェクトには、セキュリティと機能を検証するための包括的なテストが含まれています。
Vitestを使用した高速で効率的なテストフレームワークを採用しています。

### テストの実行

```bash
# すべてのテストを実行
pnpm test

# ウォッチモードで実行（開発中に便利）
pnpm run test:watch

# ブラウザでテストUIを表示
pnpm run test:ui

# カバレッジレポートを生成
pnpm run test:coverage
```

## テストの構成

### 1. セキュリティテスト（70テスト）

ファイル: `app/services/__tests__/security.server.test.ts`

#### XSS（クロスサイトスクリプティング）対策

- HTMLタグのサニタイゼーション
- エンティティのデコード
- イベントハンドラーの無害化
- SVGタグ内のスクリプト除去

#### Prompt Injection対策

- 制御文字の除去
- 連続する改行の正規化
- 危険なプロンプトパターンのエスケープ
- システムロール侵害パターンの無効化
- 指示注入パターンの無効化
- 長さ制限の適用

#### SQLインジェクション対策

- 入力値の検証
- 最小・最大長チェック
- SQL特殊文字パターンの検出
- 文字列のトリミング

#### SSRF（Server-Side Request Forgery）対策

- 正常なHTTP/HTTPS URLの検証
- 危険なプロトコルの拒否（javascript:、data:、file:等）
- ローカルホストの拒否
- プライベートIPアドレスの拒否
- URL長制限
- 無効なURL形式の拒否

#### AI応答検証

- 正常な応答の検証
- 空の応答の拒否
- サイズ制限（DoS対策）

#### レート制限

- 制限内のリクエスト許可
- 制限超過時の拒否
- 複数ユーザーの独立した制限
- リセット機能

#### ファイルセキュリティ

- ファイル名のサニタイズ（パストラバーサル攻撃対策）
- 特殊文字の除去
- 連続するドットの正規化
- 隠しファイル防止
- 長さ制限
- 日本語ファイル名のサポート
- 拡張子の取得
- MIMEタイプの検証
- ブロックされた拡張子の検出
- ファイルサイズの検証
- Magic number検証（ファイル偽装対策）
- SHA-256ハッシュ計算
- 包括的なファイル検証（統合テスト）

### 2. データベース操作テスト（26テスト）

ファイル: `app/services/__tests__/db.server.test.ts`

#### ユーザー分離の検証

- WHERE句のuserId条件の必須化
- 複数ユーザーのデータ混在防止

#### URL重複チェックのロジック

- 同じURLの複数追加防止
- ユーザーごとの同じURL保持

#### 楽観的ロックの検証

- バージョン番号の一致チェック
- バージョン番号の不一致時の拒否
- バージョン番号のインクリメント

#### カテゴリの重複防止

- 既存カテゴリ名のチェック
- 新規カテゴリの追加

#### データ整合性の検証

- 外部キー制約の確認
- カスケード削除の動作確認

#### 表示順序の管理

- displayOrderの昇順ソート
- 表示順序の更新

#### ブックマーク状態の管理

- スターの切り替え
- 既読状態の切り替え
- アーカイブの切り替え

#### SQLインジェクション対策の確認

- Drizzle ORMのプリペアドステートメント使用
- 文字列連結の禁止

#### IDOR（Insecure Direct Object Reference）対策

- 他ユーザーのリソースへのアクセス拒否
- 自分のリソースのみアクセス可能
- 管理者でもユーザーIDチェック必須

#### データのページング処理

- limit句の適用
- offset句の適用

#### トランザクション処理のロジック

- 複数操作の一括実行
- 失敗時のロールバック

## テストのベストプラクティス

### 1. テストの命名規則

- テストケース名は日本語で記述
- 「〜を確認」「〜を拒否する」「〜を受け入れる」などの明確な動詞を使用
- 期待される動作を簡潔に表現

### 2. テストの構造

```typescript
describe("機能グループ", () => {
  describe("サブ機能", () => {
    it("具体的な動作を検証", () => {
      // Arrange: テストデータの準備
      const input = "test data";

      // Act: テスト対象の実行
      const result = targetFunction(input);

      // Assert: 期待される結果の検証
      expect(result).toBe("expected");
    });
  });
});
```

### 3. テストの独立性

- 各テストは他のテストに依存しない
- テストの実行順序に依存しない
- 必要なデータは各テスト内で準備

### 4. モックとスタブ

- 外部依存（API、データベース）は適切にモック
- 実際のD1データベース接続が必要な場合は統合テストとして別途実装

### 5. エッジケースのテスト

- 正常系だけでなく異常系もテスト
- 境界値テスト（最小値、最大値、空文字列等）
- エラーハンドリングのテスト

## CI/CD統合

GitHub Actionsワークフロー（`.github/workflows/test.yml`）により、以下が自動実行されます：

### 実行速度の最適化

GitHub Actionsでは以下の最適化により、高速な実行を実現しています：

1. **並列実行**: lint、format、typecheckをmatrix strategyで並列実行
2. **concurrency設定**: 同じPRの古いワークフローを自動キャンセル
3. **pnpmキャッシュ**: 依存関係のインストールを高速化
4. **条件付きビルド**: ビルドチェックはPRのみ実行（mainへのpushではスキップ）
5. **fail-fast無効**: 一部のチェックが失敗しても他のチェックを継続

### プルリクエスト時

1. **quality-checks**（並列実行）:
   - Lintチェック
   - フォーマットチェック
   - 型チェック
2. **test**（独立実行）:
   - テスト実行（96テスト）
   - カバレッジレポート生成
3. **build**（quality-checks、test完了後）:
   - ビルド確認
4. **test-summary**（全ジョブ完了後）:
   - テスト結果のサマリー表示

### ブランチマージの条件

- すべてのテストが成功
- Lintエラーがない（警告は許可）
- 型チェックが成功（既存のエラーを除く）
- ビルドが成功

### 実行時間の目安

- **quality-checks**: 約1-2分（並列実行）
- **test**: 約1分
- **build**: 約2-3分
- **合計**: 約3-5分（並列実行により短縮）

## トラブルシューティング

### テストが失敗する場合

1. 依存関係の再インストール

   ```bash
   rm -rf node_modules pnpm-lock.yaml
   pnpm install
   ```

2. キャッシュのクリア

   ```bash
   pnpm test --clearCache
   ```

3. 特定のテストファイルのみ実行

   ```bash
   pnpm test app/services/__tests__/security.server.test.ts
   ```

### ウォッチモードが動作しない場合

1. Vitestの設定を確認

   ```bash
   cat vitest.config.ts
   ```

2. ファイル変更の検出を確認

   ```bash
   pnpm run test:watch --verbose
   ```

### カバレッジが生成されない場合

1. カバレッジプロバイダーのインストール

   ```bash
   pnpm add -D @vitest/coverage-v8
   ```

2. カバレッジ設定の確認

   ```bash
   pnpm run test:coverage
   ```

## 今後の拡張

### 追加予定のテスト

1. 統合テスト
   - 実際のD1データベースを使用したテスト
   - API エンドポイントのテスト
   - 認証フローのテスト

2. E2Eテスト
   - Playwrightを使用したブラウザテスト
   - ユーザーシナリオのテスト
   - UIコンポーネントのテスト

3. パフォーマンステスト
   - 大量データでの動作確認
   - レスポンスタイムの測定
   - メモリ使用量の監視

## 参考リソース

- Vitest公式ドキュメント: https://vitest.dev/
- Cloudflare Workers Testing: https://developers.cloudflare.com/workers/testing/
- Testing Best Practices: https://testingjavascript.com/
- OWASP Testing Guide: https://owasp.org/www-project-web-security-testing-guide/

## まとめ

- 96個のテストが実装済み（セキュリティ70、データベース26）
- すべてのテストが成功
- CI/CD統合により自動テストを実現
- セキュリティと機能の両面を包括的にカバー

テストは継続的に追加・改善していく必要があります。新機能の追加時は、必ずテストも一緒に実装してください。
